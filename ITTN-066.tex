\documentclass[PMO,authoryear,toc]{lsstdoc}
\usepackage[cache=false]{minted}
% !TeX TXS-program:compile = txs:///pdflatex/[-shell-escape]

\input{meta}

% Package imports go here.

% Local commands go here.

%If you want glossaries
%\input{aglossary.tex}
%\makeglossaries

\title{Kubernetes Use Policy}

% Optional subtitle
% \setDocSubtitle{A subtitle}

\author{%
Joshua Hoblitt
}

\setDocRef{ITTN-066}
\setDocUpstreamLocation{\url{https://github.com/lsst-it/ittn-066}}

\date{\vcsDate}

% Optional: name of the document's curator
% \setDocCurator{The Curator of this Document}

\setDocAbstract{%
Requirements and restrictions for services deployment upon Rubin Kubernetes clusters.
}

% Change history defined here.
% Order: oldest first.
% Fields: VERSION, DATE, DESCRIPTION, OWNER NAME.
% See LPM-51 for version number policy.
\setDocChangeRecord{%
  \addtohist{1}{YYYY-MM-DD}{Unreleased.}{Joshua Hoblitt}
}


\begin{document}

% Create the title page.
\maketitle

\section{Pods}\label{sec:pod}

\subsection{Resource \code{requests} and \code{limits}}

All containers within a pod SHALL declare resource requests and limits for memory and cpu.

XXX does this requirement include initContainers?

\subsubsection{Example \code{podSpec} fragment}

\begin{minted}{yaml}
    resources:
      limits:
        cpu: "2"
        memory: 12Gi
      requests:
        cpu: "1"
        memory: 8Gi
\end{minted}

Containers should set a fairly conservative limits to prevent suddent load spikes impacting other pods schedule upon the same node.

\subsubsection{Maxmimum Allowed Limits}

\begin{center}
\begin{tabular}{|l|l|}
\hline
    \bf cpu & \bf memory \\ \hline
    8 & 32Gi \\ \hline
\end{tabular}
\end{center}

\subsection{Priviledged Containers}

Privileged \code{containters} and \code{initContainers} SHALL be used only by the infrastructure team to provide platform level services.

This restriction is suspended for \code{initContainers} in pods which are using multus to connect to DDS until either the need for the \code{lsstit/ddsnet4u initContainer} is removed or DDS is retired.

\subsubsection{Example podSpec fragment}

\begin{minted}{yaml}
    securityContext:
      privileged: false
\end{minted}

\subsubsection{Discussion}

Common community provided deployments have been identified which use \code{priviledged initContainers} to modify non-namespaced sysctls which will affect all containers run upon the node and have the potential to make the system unstable.

Example:

\begin{minted}{yaml}
      initContainers:
      - command:
        - sysctl
        - -w
        - vm.max_map_count=262144
        securityContext:
          privileged: true
\end{minted}

\subsection{Pod Security Policies}

\code{PodSecurityPolicy} was removed in k8s 1.25 and SHALL NOT be used.

\subsubsection{Discussion}

The usage of \code{PodSecurityPolicy} would prevent routine updates to k8s >= 1.25.

\section{Services}\label{sec:svc}

\subsection{Service Types}

The following service types SHALL be allowed:

\begin{itemize}
  \item \code{ClusterIP}
  \item \code{ExternalName}
  \item \code{LoadBalancer}
\end{itemize}

The \code{NodePort} service type SHALL NOT be used.

\subsubsection{Discussion}

The \code{NodePort} service type bypasses the CNI overlay and the pool of external IPs allocated for use by \code{LoadBalancer} services.

\appendix
% Include all the relevant bib files.
% https://lsst-texmf.lsst.io/lsstdoc.html#bibliographies
\section{References} \label{sec:bib}
\renewcommand{\refname}{} % Suppress default Bibliography section
\bibliography{local,lsst,lsst-dm,refs_ads,refs,books}

% Make sure lsst-texmf/bin/generateAcronyms.py is in your path
\section{Acronyms} \label{sec:acronyms}
\input{acronyms.tex}
% If you want glossary uncomment below -- comment out the two lines above
%\printglossaries





\end{document}
